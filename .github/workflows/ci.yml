run-name:
    "${{ github.event_name == 'push' && format('CI · main · {0}', github.event.head_commit.message) || format('CI · PR #{0} · {1}',
    github.event.pull_request.number, github.event.pull_request.title) }}"

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    lint:
        name: Lint
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: pnpm
            - run: pnpm install --frozen-lockfile
            - run: pnpm build
            - run: pnpm lint
            - run: pnpm format:check

    test-unit:
        name: Unit Tests
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                node-version: [20, 22]
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: pnpm
            - run: pnpm install --frozen-lockfile
            - run: pnpm build
            - run: pnpm test

    test-integration:
        name: Integration · ${{ matrix.runtime }}
        runs-on: ubuntu-latest
        needs: test-unit
        strategy:
            fail-fast: false
            matrix:
                runtime: [node, bun, deno]
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: pnpm
            - uses: oven-sh/setup-bun@v2
              if: matrix.runtime == 'bun'
              with:
                  bun-version: latest
            - uses: denoland/setup-deno@v2
              if: matrix.runtime == 'deno'
              with:
                  deno-version: v2.x
            - run: pnpm install --frozen-lockfile
            - run: pnpm build
            - run: pnpm --filter markdown-for-agents test:integration:${{ matrix.runtime }}
            - name: Middleware integration tests
              if: matrix.runtime == 'node'
              run: pnpm --filter './packages/middleware/*' run test:integration
