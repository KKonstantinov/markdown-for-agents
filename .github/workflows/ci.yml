run-name:
    "${{ github.event_name == 'push' && format('CI 路 main 路 {0}', github.event.head_commit.message) || format('CI 路 PR #{0} 路 {1}',
    github.event.pull_request.number, github.event.pull_request.title) }}"

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    lint:
        name: Lint
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: pnpm
            - run: pnpm install --frozen-lockfile
            - run: pnpm build
            - run: pnpm lint
            - run: pnpm format:check

    test-unit:
        name: Unit Tests
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                node-version: [20, 22]
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: pnpm
            - run: pnpm install --frozen-lockfile
            - run: pnpm build
            - run: pnpm test

    test-integration:
        name: Integration Tests
        runs-on: ubuntu-latest
        needs: test-unit
        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: pnpm
            - run: pnpm install --frozen-lockfile
            - run: pnpm build
            - run: pnpm test:integration
